<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misi Untuk Ika</title>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #0b0d17;
            background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            font-family: 'VT323', monospace;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; color: #fff;
        }
        #game-box {
            position: relative; width: 100%; max-width: 480px; height: 100vh; max-height: 800px;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #astronaut {
            position: absolute; width: 50px; height: 50px; font-size: 40px; left: 50px; top: 50%;
            transition: transform 0.1s; z-index: 10;
        }
        .spin-anim { animation: spinEffect 0.6s ease-in-out; }
        @keyframes spinEffect { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.3); } 100% { transform: rotate(360deg) scale(1); } }
        .obstacle, .star, .fun-item { position: absolute; font-size: 30px; left: 100%; }
        
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 13, 23, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center;
        }
        h1 { font-size: 3rem; color: #4facfe; text-shadow: 0 0 10px #00f260; margin-bottom: 10px; }
        p.subtitle { font-family: 'Nunito', sans-serif; font-size: 1rem; color: #ccc; margin-bottom: 40px; padding: 0 20px; }
        
        .btn {
            background: transparent; border: 2px solid #4facfe; color: #4facfe; padding: 15px 30px;
            font-family: 'VT323', monospace; font-size: 1.5rem; margin: 10px; cursor: pointer;
            transition: all 0.3s; width: 200px; text-transform: uppercase; letter-spacing: 2px;
        }
        .btn:hover, .btn:active { background: #4facfe; color: #0b0d17; box-shadow: 0 0 15px #4facfe; }
        
        .menu-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        
        .corner-display {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid #ffd700; color: #ffd700;
            padding: 8px 15px; border-radius: 20px; font-size: 1.1rem; z-index: 110;
            display: flex; align-items: center; gap: 5px;
        }
        
        #hud { position: absolute; top: 70px; left: 20px; font-size: 1.5rem; z-index: 50; display: none; }
        
        #pause-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.1); border: 1px solid #fff; color: #fff;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; z-index: 110; display: none;
            justify-content: center; align-items: center;
        }

        #mining-modal, #shop-modal, #memory-modal, #battle-modal, #pause-menu, #promo-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a2e; z-index: 120;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #pause-menu { background: rgba(11, 13, 23, 0.9); backdrop-filter: blur(5px); }

        .msg-float {
            position: absolute; color: rgba(255,255,255,0.9); font-family: 'Nunito', sans-serif;
            font-size: 1rem; font-weight: bold; white-space: nowrap;
            animation: fadeUp 2.5s forwards; pointer-events: none; z-index: 90;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(0); } 15% { opacity: 1; transform: translateY(-10px); } 100% { opacity: 0; transform: translateY(-60px); } }
        
        .final-letter { font-family: 'Nunito', sans-serif; text-align: left; font-size: 0.95rem; line-height: 1.6; color: #333; }
        
        #moon-rock { font-size: 100px; cursor: pointer; transition: transform 0.1s; margin: 20px; filter: drop-shadow(0 0 15px rgba(100,100,255,0.5)); }
        .rock-hit { transform: scale(0.9); }
        
        .close-btn {
            margin-top: 20px; background: #ff4b4b; border: none; color: white;
            padding: 8px 16px; border-radius: 5px; cursor: pointer;
            font-family: 'VT323', monospace; font-size: 1.2rem;
        }
        .mining-score { font-size: 1.5rem; color: #ffd700; margin-bottom: 10px; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 50vh; overflow-y: auto; padding: 10px; width: 90%; }
        .shop-section-title { width: 100%; color: #fff; background: #2c5364; padding: 5px; text-align: center; grid-column: span 2; margin-top: 10px; border-radius: 5px; }
        .shop-item { background: rgba(255, 255, 255, 0.1); border: 1px solid #4facfe; border-radius: 10px; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .shop-emoji { font-size: 40px; margin-bottom: 5px; }
        .shop-btn { margin-top: 5px; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-family: 'VT323', monospace; width: 100%; }
        .btn-buy { background: #4facfe; color: #000; }
        .btn-equip { background: #00f260; color: #000; }
        .btn-equipped { background: #ccc; color: #555; cursor: default; }
        
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .memory-card { width: 60px; height: 60px; background: #4facfe; border-radius: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 30px; color: transparent; transition: all 0.3s; border: 2px solid #fff; }
        .memory-card.flipped, .memory-card.matched { background: #fff; color: #000; }
        .memory-card.matched { background: #00f260; border-color: #00f260; }
        
        .battle-arena { width: 90%; height: 300px; background: url('https://img.freepik.com/free-vector/space-background-with-landscape-planet_107791-628.jpg'); background-size: cover; border: 2px solid #4facfe; border-radius: 10px; position: relative; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; padding: 20px; }
        .fighter { display: flex; flex-direction: column; align-items: center; position: relative; }
        .fighter-emoji { font-size: 60px; transition: transform 0.2s; }
        .hit-anim { animation: shake 0.5s; filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }
        .hp-bar { width: 80px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px; position: relative; }
        .hp-fill { height: 100%; background: #00f260; width: 100%; transition: width 0.3s; }
        .battle-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; }
        .battle-btn { background: #4facfe; border: none; padding: 15px; color: #000; font-family: 'VT323'; font-size: 1.2rem; cursor: pointer; border-radius: 5px; }
        .battle-btn:disabled { background: #555; cursor: not-allowed; }
        .dmg-text { position: absolute; color: #ff4b4b; font-weight: bold; font-size: 1.5rem; animation: floatUp 1s forwards; top: 0; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

        /* PROMO & VIP STYLES */
        #promo-trigger {
            position: absolute; top: 70px; left: 20px;
            width: 50px; height: 50px; background: linear-gradient(135deg, #ffd700, #ff8c00);
            border-radius: 50%; border: 2px solid #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 25px; cursor: pointer; z-index: 110;
            box-shadow: 0 0 15px #ffd700;
            animation: pulsePromo 1.5s infinite;
        }
        @keyframes pulsePromo { 0% { transform: scale(1); box-shadow: 0 0 10px #ffd700; } 50% { transform: scale(1.1); box-shadow: 0 0 20px #ffd700; } 100% { transform: scale(1); box-shadow: 0 0 10px #ffd700; } }

        #vip-badge {
            position: absolute; top: 70px; left: 20px;
            background: linear-gradient(90deg, #ffd700, #ffecb3);
            color: #5a3a00; padding: 5px 10px; border-radius: 15px;
            font-family: 'VT323'; font-size: 1.2rem; font-weight: bold;
            border: 2px solid #fff; display: none; z-index: 110;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .promo-content { text-align: center; width: 80%; }
        .promo-price { text-decoration: line-through; color: #ff4b4b; margin-right: 10px; }
        .promo-free { color: #00f260; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="game-box">
        <div id="main-menu">
            <h1>STAR JOURNEY</h1>
            <p class="subtitle">Bantu Astronot mengumpulkan sinyal memori.</p>
            <button class="btn" onclick="startGame()">üöÄ Mulai Misi</button>
            <div class="menu-row">
                <button class="btn" style="width: auto;" onclick="openMining()">‚õèÔ∏è Tambang</button>
                <button class="btn" style="width: auto;" onclick="openBattle()">‚öîÔ∏è Battle</button>
                <button class="btn" style="width: auto;" onclick="openMemory()">üîÆ Memori</button>
                <button class="btn" style="width: auto;" onclick="openShop()">üõí Toko</button>
            </div>
            <button class="btn" style="width: auto; font-size: 1rem; margin-top: 5px;" onclick="showAbout()">Tentang</button>
            
            <div class="corner-display">ü™ô <span id="coin-display">0</span></div>
            
            <div id="promo-trigger" onclick="openPromo()">üéÅ</div>
            <div id="vip-badge">üëë VIP MEMBER</div>
        </div>

        <button id="pause-btn" onclick="togglePause()">‚è∏Ô∏è</button>

        <div id="pause-menu">
            <h2 style="color: #4facfe; margin-bottom: 20px; font-size: 2.5rem;">PAUSED</h2>
            <button class="btn" onclick="togglePause()">Lanjut Main</button>
            <button class="btn" onclick="restartGame()">Ulangi</button>
            <button class="btn" style="border-color: #ff4b4b; color: #ff4b4b;" onclick="exitToMenu()">Menu Utama</button>
        </div>

        <div id="mining-modal">
            <h2 style="color: #4facfe; font-family: 'VT323'; margin-bottom: 10px;">MOON MINING</h2>
            <div class="mining-score">Koin: <span id="mine-score">0</span></div>
            <div id="moon-rock" onclick="mineRock()">üåë</div>
            <p style="color: #aaa; font-size: 0.9rem;">Ketuk batu untuk cari koin!</p>
            <button class="close-btn" onclick="closeMining()">Kembali</button>
        </div>

        <div id="memory-modal">
            <h2 style="color: #4facfe; font-family: 'VT323'; margin-bottom: 10px;">SPACE MEMORY</h2>
            <div class="memory-grid" id="memory-board"></div>
            <button class="close-btn" onclick="closeMemory()">Kembali</button>
        </div>

        <div id="battle-modal">
            <h2 style="color: #ff4b4b; font-family: 'VT323'; margin-bottom: 5px;">ALIEN BATTLE</h2>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:10px;">Lawan Alien untuk dapat Koin!</p>
            <div class="battle-arena">
                <div class="fighter" id="hero-fighter">
                    <div class="hp-bar"><div class="hp-fill" id="hero-hp"></div></div>
                    <div class="fighter-emoji" id="hero-sprite">üßë‚ÄçüöÄ</div><span style="font-size:0.8rem">YOU</span>
                </div>
                <div class="fighter" id="enemy-fighter">
                    <div class="hp-bar"><div class="hp-fill" id="enemy-hp"></div></div>
                    <div class="fighter-emoji" id="enemy-sprite">üëæ</div><span style="font-size:0.8rem">ALIEN</span>
                </div>
            </div>
            <div class="battle-controls">
                <button class="battle-btn" id="atk-btn" onclick="playerAttack()">üî´ Serang</button>
                <button class="battle-btn" style="background:#00f260" onclick="playerHeal()">üíä Heal</button>
            </div>
            <div id="battle-log" style="height:20px; color:#ffd700; margin-top:5px; font-size:0.9rem;"></div>
            <button class="close-btn" onclick="closeBattle()">Kabur</button>
        </div>

        <div id="shop-modal">
            <h2 style="color: #4facfe; font-family: 'VT323';">TOKO SPACE</h2>
            <p style="color: #ffd700;">Saldo: ü™ô <span id="shop-balance">0</span></p>
            <div class="shop-grid" id="shop-container"></div>
            <button class="close-btn" onclick="closeShop()">Kembali</button>
        </div>

        <div id="promo-modal">
            <div class="promo-content">
                <h2 style="color: #ffd700; font-family: 'VT323'; font-size: 2.5rem; margin-bottom: 10px;">SPECIAL OFFER!</h2>
                <div style="font-size: 4rem; margin-bottom: 10px;">üíé</div>
                <p style="font-family: 'Nunito'; margin-bottom: 20px;">Dapatkan <b>10.000 Koin</b> Langsung!</p>
                <p style="font-family: 'Nunito'; font-size: 0.9rem; color: #ccc; margin-bottom: 20px;">
                    <i>"Beri kesempatan pada Darius dan dapatkan 10.000 koin langsung."</i>
                </p>
                <div style="margin-bottom: 20px; font-family: 'VT323'; font-size: 1.5rem;">
                    <span class="promo-price">Rp 99.000</span> <span class="promo-free">GRATIS</span>
                </div>
                <button class="btn" style="background: #00f260; color: #000; border: none; width: 100%;" onclick="claimPromo()">AMBIL SEKARANG</button>
                <button class="close-btn" style="background: transparent; border: 1px solid #aaa; color: #aaa; margin-top: 10px;" onclick="closePromo()">Nanti Saja</button>
            </div>
        </div>

        <div id="hud">Sinyal: <span id="score">0</span>%</div>
        <div id="astronaut">üßë‚ÄçüöÄ</div>
        <div id="game-objects"></div>
    </div>

    <script>
        // --- ONLINE AUDIO ASSETS (STABLE CDN) ---
        const sounds = {
            // Lofi Space BGM (Pixabay)
            bgm: new Audio('https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3'),
            // UI Click (Simple Pop/Tick)
            click: new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_5b8277259f.mp3'), // Menggunakan suara click yg lebih soft
            jump: new Audio('https://cdn.pixabay.com/download/audio/2022/03/24/audio_c8c8a73467.mp3'), 
            coin: new Audio('https://cdn.pixabay.com/download/audio/2021/08/09/audio_88447e769f.mp3'), 
            crash: new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_c290130986.mp3'), 
            mining: new Audio('https://cdn.pixabay.com/download/audio/2022/03/24/audio_3f728c7349.mp3'),
            laser: new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_3320c2a71f.mp3'), 
            hit: new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_243463a0a6.mp3'),
            win: new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c153e1.mp3'), 
            card: new Audio('https://cdn.pixabay.com/download/audio/2022/03/24/audio_8340d2d323.mp3'),
            notif: new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_c6ccf3232f.mp3')
        };

        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.3; 

        function playSound(key) {
            if(sounds[key]) {
                sounds[key].currentTime = 0;
                sounds[key].play().catch(() => { });
            }
        }

        function playBGM() {
            sounds.bgm.play().catch(() => {});
        }

        const astronaut = document.getElementById('astronaut');
        const gameBox = document.getElementById('game-box');
        const mainMenu = document.getElementById('main-menu');
        const hud = document.getElementById('hud');
        const scoreEl = document.getElementById('score');
        const gameObjectsDiv = document.getElementById('game-objects');
        const pauseBtn = document.getElementById('pause-btn');
        const pauseMenu = document.getElementById('pause-menu');
        
        const miningModal = document.getElementById('mining-modal');
        const shopModal = document.getElementById('shop-modal');
        const memoryModal = document.getElementById('memory-modal');
        const battleModal = document.getElementById('battle-modal');
        const promoModal = document.getElementById('promo-modal');
        
        const coinDisplay = document.getElementById('coin-display');
        const shopBalance = document.getElementById('shop-balance');
        const shopContainer = document.getElementById('shop-container');
        const promoTrigger = document.getElementById('promo-trigger');
        const vipBadge = document.getElementById('vip-badge');
        
        let moonCoins = parseInt(localStorage.getItem('moonCoins')) || 0;
        let unlockedSkins = JSON.parse(localStorage.getItem('unlockedSkins')) || ['skin_0'];
        let unlockedWeapons = JSON.parse(localStorage.getItem('unlockedWeapons')) || ['wep_0'];
        let currentSkin = localStorage.getItem('currentSkin') || 'skin_0';
        let currentWeapon = localStorage.getItem('currentWeapon') || 'wep_0';
        let isVip = localStorage.getItem('isVip') === 'true';

        let isGameRunning = false, isPaused = false, hasShownLetter = false;
        let score = 0, gravity = 0.25, velocity = 0, astroTop = 50; 
        let gameLoop = null, spawnerLoop = null, msgIndex = 0;

        const skins = [
            { id: 'skin_0', name: 'Default', emoji: 'üßë‚ÄçüöÄ', price: 0 },
            { id: 'skin_1', name: 'Super Astro', emoji: 'ü¶∏', price: 50 },
            { id: 'skin_2', name: 'Mecha Bot', emoji: 'ü§ñ', price: 150 },
            { id: 'skin_3', name: 'Alien', emoji: 'üëΩ', price: 300 },
            { id: 'skin_4', name: 'Pixel Void', emoji: 'üëæ', price: 500 }
        ];
        const weapons = [
            { id: 'wep_0', name: 'Laser Gun', emoji: 'üî´', dmg: 15, price: 0 },
            { id: 'wep_1', name: 'Plasma Sword', emoji: '‚öîÔ∏è', dmg: 35, price: 200 },
            { id: 'wep_2', name: 'Rocket', emoji: 'üöÄ', dmg: 60, price: 500 },
            { id: 'wep_3', name: 'Zeus Thunder', emoji: '‚ö°', dmg: 100, price: 1000 }
        ];
        const messages = ["Hai Ika...", "Maaf ya...", "Aku sadar...", "Aku banyak salah...", "Kali ini...", "Aku akan lebih baik...", "Terima kasih..."];
        const funItems = [
            { emoji: 'üê±', type: 'cat', msg: 'Meow! (+10)' },
            { emoji: 'üçï', type: 'pizza', msg: 'Nyam! (+10)' },
            { emoji: 'üõ∏', type: 'ufo', msg: 'Wuzzz! (+10)' },
            { emoji: 'üíé', type: 'gem', msg: 'Bling! (+10)' }
        ];

        // INITIALIZATION
        updateCoinDisplay(); updateAstronautSkin(); updateBattleButton(); checkVipStatus();

        function checkVipStatus() {
            if (isVip) {
                promoTrigger.style.display = 'none';
                vipBadge.style.display = 'block';
            } else {
                promoTrigger.style.display = 'flex';
                vipBadge.style.display = 'none';
            }
        }

        function updateCoinDisplay() {
            coinDisplay.innerText = moonCoins; document.getElementById('mine-score').innerText = moonCoins;
            shopBalance.innerText = moonCoins; localStorage.setItem('moonCoins', moonCoins);
        }
        function updateAstronautSkin() {
            const skinData = skins.find(s => s.id === currentSkin);
            if(skinData) { astronaut.innerText = skinData.emoji; document.getElementById('hero-sprite').innerText = skinData.emoji; }
        }
        function updateBattleButton() {
            const wepData = weapons.find(w => w.id === currentWeapon);
            document.getElementById('atk-btn').innerHTML = `${wepData.emoji} Serang`;
        }

        // --- PROMO & VIP ---
        function openPromo() { playSound('click'); promoModal.style.display = 'flex'; }
        function closePromo() { playSound('click'); promoModal.style.display = 'none'; }
        
        function claimPromo() {
            playSound('win');
            moonCoins += 10000;
            isVip = true;
            localStorage.setItem('isVip', 'true');
            localStorage.setItem('moonCoins', moonCoins);
            updateCoinDisplay();
            checkVipStatus();
            closePromo();
            
            Swal.fire({
                title: 'VIP AKTIF! üëë',
                text: 'Terima kasih atas kesempatannya. 10.000 Koin telah ditambahkan!',
                icon: 'success',
                background: '#1a1a2e', color: '#fff', confirmButtonColor: '#ffd700'
            });
        }

        // --- NAVIGATION ---
        function togglePause() {
            playSound('click');
            if (isPaused) {
                isPaused = false; pauseMenu.style.display = 'none';
            } else {
                isPaused = true; pauseMenu.style.display = 'flex';
            }
        }
        function restartGame() {
            playSound('click');
            pauseMenu.style.display = 'none';
            clearInterval(gameLoop);
            clearInterval(spawnerLoop);
            startGame();
        }
        function exitToMenu() {
            playSound('click');
            isGameRunning = false;
            clearInterval(gameLoop); clearInterval(spawnerLoop);
            pauseMenu.style.display = 'none';
            hud.style.display = 'none';
            pauseBtn.style.display = 'none';
            gameObjectsDiv.innerHTML = '';
            mainMenu.style.display = 'flex';
        }

        // --- MINI GAMES ---
        function openMining() { playSound('click'); miningModal.style.display = 'flex'; }
        function closeMining() { playSound('click'); miningModal.style.display = 'none'; }
        function mineRock() {
            playSound('mining'); 
            playSound('coin'); 
            const gain = Math.floor(Math.random() * 2) + 1;
            moonCoins += gain; updateCoinDisplay();
            const rock = document.getElementById('moon-rock'); rock.classList.add('rock-hit');
            setTimeout(() => { rock.classList.remove('rock-hit'); }, 100);
            showMiniFloat(`+${gain}ü™ô`, '50%', '40%', miningModal);
        }

        let memoryCards = [], hasFlippedCard = false, lockBoard = false, firstCard, secondCard, matchedPairs = 0;
        const memoryIcons = ['üåç', 'üöÄ', 'üëΩ', '‚≠ê', '‚òÑÔ∏è', '‚ù§Ô∏è'];
        function openMemory() {
            playSound('click'); memoryModal.style.display = 'flex';
            const board = document.getElementById('memory-board'); board.innerHTML = '';
            matchedPairs = 0; hasFlippedCard = false; lockBoard = false;
            let cards = [...memoryIcons, ...memoryIcons].sort(() => 0.5 - Math.random());
            cards.forEach(icon => {
                const card = document.createElement('div'); card.classList.add('memory-card');
                card.dataset.icon = icon; card.innerText = icon; 
                card.addEventListener('click', flipCard); board.appendChild(card);
            });
        }
        function closeMemory() { playSound('click'); memoryModal.style.display = 'none'; }
        function flipCard() {
            if (lockBoard || this === firstCard) return;
            playSound('card'); this.classList.add('flipped');
            if (!hasFlippedCard) { hasFlippedCard = true; firstCard = this; return; }
            secondCard = this; checkForMatch();
        }
        function checkForMatch() { let isMatch = firstCard.dataset.icon === secondCard.dataset.icon; isMatch ? disableCards() : unflipCards(); }
        function disableCards() {
            playSound('coin'); firstCard.removeEventListener('click', flipCard); secondCard.removeEventListener('click', flipCard);
            firstCard.classList.add('matched'); secondCard.classList.add('matched'); matchedPairs++;
            if(matchedPairs === memoryIcons.length) {
                setTimeout(() => {
                    playSound('win'); moonCoins += 50; updateCoinDisplay();
                    Swal.fire({title: 'Menang!', text: '+50 Koin!', icon: 'success', background: '#1a1a2e', color: '#fff'});
                }, 500);
            }
            resetBoard();
        }
        function unflipCards() { lockBoard = true; setTimeout(() => { firstCard.classList.remove('flipped'); secondCard.classList.remove('flipped'); resetBoard(); }, 1000); }
        function resetBoard() { [hasFlippedCard, lockBoard] = [false, false];[firstCard, secondCard] = [null, null]; }

        let heroHp = 100, enemyHp = 100; const maxHp = 100;
        function openBattle() { playSound('click'); battleModal.style.display = 'flex'; resetBattle(); }
        function closeBattle() { playSound('click'); battleModal.style.display = 'none'; }
        function resetBattle() {
            heroHp = maxHp; enemyHp = maxHp; updateHpUI();
            document.getElementById('battle-log').innerText = "Alien liar muncul!";
            document.getElementById('enemy-sprite').classList.remove('hit-anim'); document.getElementById('hero-sprite').classList.remove('hit-anim');
            document.getElementById('atk-btn').disabled = false;
        }
        function updateHpUI() { document.getElementById('hero-hp').style.width = heroHp + '%'; document.getElementById('enemy-hp').style.width = enemyHp + '%'; }
        function playerAttack() {
            playSound('laser'); const wep = weapons.find(w => w.id === currentWeapon);
            const dmg = Math.floor(wep.dmg * (0.8 + Math.random() * 0.4)); 
            enemyHp -= dmg; if(enemyHp < 0) enemyHp = 0; updateHpUI();
            showDmg(dmg, 'enemy-fighter');
            document.getElementById('enemy-sprite').classList.add('hit-anim'); setTimeout(() => document.getElementById('enemy-sprite').classList.remove('hit-anim'), 500);
            document.getElementById('battle-log').innerText = `Kamu menyerang: ${dmg} dmg!`;
            if (enemyHp === 0) { winBattle(); } else { document.getElementById('atk-btn').disabled = true; setTimeout(alienTurn, 1000); }
        }
        function playerHeal() {
            playSound('notif'); const heal = 30; heroHp += heal; if (heroHp > maxHp) heroHp = maxHp; updateHpUI();
            document.getElementById('battle-log').innerText = `Kamu healing +${heal} HP`;
            document.getElementById('atk-btn').disabled = true; setTimeout(alienTurn, 1000);
        }
        function alienTurn() {
            playSound('hit'); const dmg = Math.floor(10 + Math.random() * 15);
            heroHp -= dmg; if (heroHp < 0) heroHp = 0; updateHpUI();
            showDmg(dmg, 'hero-fighter');
            document.getElementById('hero-sprite').classList.add('hit-anim'); setTimeout(() => document.getElementById('hero-sprite').classList.remove('hit-anim'), 500);
            document.getElementById('battle-log').innerText = `Alien menyerang: ${dmg} dmg!`;
            if (heroHp === 0) { playSound('crash'); Swal.fire({ title: 'Kalah!', text: 'Kamu pingsan...', icon: 'error', background: '#1a1a2e', color: '#fff' }); resetBattle(); }
            document.getElementById('atk-btn').disabled = false;
        }
        function winBattle() {
            playSound('win'); const reward = 50 + Math.floor(Math.random() * 50); moonCoins += reward; updateCoinDisplay();
            Swal.fire({ title: 'Menang!', text: `Alien kabur! Kamu dapat ${reward} Koin!`, icon: 'success', background: '#1a1a2e', color: '#fff' }); resetBattle();
        }
        function showDmg(val, targetId) {
            const el = document.getElementById(targetId); const float = document.createElement('div');
            float.classList.add('dmg-text'); float.innerText = `-${val}`; el.appendChild(float); setTimeout(() => float.remove(), 1000);
        }

        function openShop() { playSound('click'); renderShop(); shopModal.style.display = 'flex'; }
        function closeShop() { playSound('click'); shopModal.style.display = 'none'; }
        function renderShop() {
            shopContainer.innerHTML = '';
            const skinTitle = document.createElement('div'); skinTitle.className = 'shop-section-title'; skinTitle.innerText = "SKIN KARAKTER"; shopContainer.appendChild(skinTitle);
            skins.forEach(item => createShopItem(item, 'skin'));
            const wepTitle = document.createElement('div'); wepTitle.className = 'shop-section-title'; wepTitle.innerText = "SENJATA BATTLE"; shopContainer.appendChild(wepTitle);
            weapons.forEach(item => createShopItem(item, 'weapon'));
        }
        function createShopItem(item, type) {
            const div = document.createElement('div'); div.className = 'shop-item';
            let isUnlocked, isEquipped;
            if (type === 'skin') { isUnlocked = unlockedSkins.includes(item.id); isEquipped = currentSkin === item.id; } 
            else { isUnlocked = unlockedWeapons.includes(item.id); isEquipped = currentWeapon === item.id; }
            let btnHtml = isEquipped ? `<button class="shop-btn btn-equipped">Terpakai</button>` : isUnlocked ? `<button class="shop-btn btn-equip" onclick="equipItem('${item.id}', '${type}')">Pakai</button>` : `<button class="shop-btn btn-buy" onclick="buyItem('${item.id}', ${item.price}, '${type}')">Beli (${item.price})</button>`;
            div.innerHTML = `<div class="shop-emoji">${item.emoji}</div><div style="font-size:0.9rem; margin-bottom:5px;">${item.name}</div>${type === 'weapon' ? `<div style="font-size:0.7rem; color:#ff4b4b">DMG: ${item.dmg}</div>` : ''}${btnHtml}`;
            shopContainer.appendChild(div);
        }
        function buyItem(id, price, type) {
            if (moonCoins >= price) {
                playSound('coin'); moonCoins -= price;
                if (type === 'skin') { unlockedSkins.push(id); localStorage.setItem('unlockedSkins', JSON.stringify(unlockedSkins)); } 
                else { unlockedWeapons.push(id); localStorage.setItem('unlockedWeapons', JSON.stringify(unlockedWeapons)); }
                updateCoinDisplay(); renderShop();
                Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Item dibeli!', timer: 800, showConfirmButton: false, background: '#1a1a2e', color: '#fff' });
            } else { playSound('crash'); Swal.fire({ icon: 'error', title: 'Ups!', text: 'Koin kurang!', background: '#1a1a2e', color: '#fff' }); }
        }
        function equipItem(id, type) {
            playSound('click');
            if (type === 'skin') { currentSkin = id; localStorage.setItem('currentSkin', currentSkin); updateAstronautSkin(); } 
            else { currentWeapon = id; localStorage.setItem('currentWeapon', currentWeapon); updateBattleButton(); }
            renderShop();
        }
        function showAbout() { playSound('click'); Swal.fire({ title: 'Info', text: 'Kumpulkan Koin, Beli Skin & Senjata, Kalahkan Alien!', background: '#0b0d17', color: '#fff', confirmButtonColor: '#4facfe' }); }

        // --- MAIN GAME LOOP ---
        function startGame() {
            if (gameLoop) clearInterval(gameLoop);
            if (spawnerLoop) clearInterval(spawnerLoop);

            playBGM(); mainMenu.style.display = 'none'; hud.style.display = 'block'; pauseBtn.style.display = 'flex';
            isGameRunning = true; isPaused = false; hasShownLetter = false; score = 0; scoreEl.innerText = "0"; astroTop = 50; velocity = 0; msgIndex = 0;
            gameObjectsDiv.innerHTML = ''; 
            
            gameLoop = setInterval(updateGame, 20); 
            spawnerLoop = setInterval(spawnObject, 1500);
        }
        function updateGame() {
            if (!isGameRunning || isPaused) return;
            velocity += gravity; astroTop += (velocity / 5);
            if (astroTop > 95) gameOver(); if (astroTop < 0) astroTop = 0;
            astronaut.style.top = astroTop + '%';
            if (!astronaut.classList.contains('spin-anim')) astronaut.style.transform = `rotate(${velocity * 2}deg)`;
            document.querySelectorAll('.obj-item').forEach(obj => {
                let leftPos = parseFloat(obj.getAttribute('data-left')); leftPos -= 0.8;
                obj.setAttribute('data-left', leftPos); obj.style.left = leftPos + '%';
                if (leftPos < -10) obj.remove(); checkCollision(obj);
            });
        }
        function jump() { if (isGameRunning && !isPaused) { playSound('jump'); velocity = -6; } }
        document.body.addEventListener('mousedown', jump);
        document.body.addEventListener('touchstart', (e) => {
            if (e.target.closest('.btn') || e.target.closest('.shop-btn') || e.target.closest('.battle-btn') || e.target.closest('.close-btn') || e.target.closest('#mining-modal') || e.target.closest('#shop-modal') || e.target.closest('#memory-modal') || e.target.closest('#battle-modal') || e.target.closest('#pause-btn') || e.target.closest('#pause-menu') || e.target.closest('#promo-modal') || e.target.closest('#promo-trigger')) return;
            e.preventDefault(); jump();
        });
        document.body.addEventListener('keydown', (e) => { if (e.code === 'Space' || e.code === 'ArrowUp') jump(); });

        function spawnObject() {
            if (!isGameRunning || isPaused) return;
            let rand = Math.random(); const el = document.createElement('div'); el.classList.add('obj-item'); el.setAttribute('data-left', 100);
            const randomTop = Math.floor(Math.random() * 80) + 10; el.style.top = randomTop + '%'; el.style.position = 'absolute'; el.style.left = '100%';
            if (rand < 0.15) {
                const item = funItems[Math.floor(Math.random() * funItems.length)];
                el.innerText = item.emoji; el.classList.add('fun-item'); el.setAttribute('data-type', 'fun'); el.setAttribute('data-msg', item.msg);
            } else if (rand < 0.55) {
                el.innerText = 'üåü'; el.classList.add('star'); el.setAttribute('data-type', 'star');
            } else {
                el.innerText = '‚òÑÔ∏è'; el.classList.add('obstacle'); el.setAttribute('data-type', 'obstacle');
            }
            gameObjectsDiv.appendChild(el);
        }
        function checkCollision(obj) {
            const r1 = astronaut.getBoundingClientRect(); const r2 = obj.getBoundingClientRect();
            if (r1.left + 10 < r2.right - 10 && r1.right - 10 > r2.left + 10 && r1.top + 10 < r2.bottom - 10 && r1.bottom - 10 > r2.top + 10) {
                const type = obj.getAttribute('data-type'); if (type === 'obstacle') gameOver(); else if (type === 'fun') collectFunItem(obj); else collectStar(obj);
            }
        }
        function collectFunItem(el) {
            playSound('coin'); const msg = el.getAttribute('data-msg'); el.remove(); score += 5; moonCoins += 10; scoreEl.innerText = score; updateCoinDisplay();
            showFloatingText(msg + " (+10ü™ô)", '#ffeb3b'); astronaut.classList.add('spin-anim'); setTimeout(() => astronaut.classList.remove('spin-anim'), 600);
            if (score >= 100 && !hasShownLetter) showLetter();
        }
        function collectStar(starEl) {
            playSound('coin'); starEl.remove(); score += 10; moonCoins += 2; scoreEl.innerText = score; updateCoinDisplay();
            let txt = "ü§ç"; if (msgIndex < messages.length) { txt = messages[msgIndex]; msgIndex++; }
            showFloatingText(txt + " (+2ü™ô)", '#fff'); if (score >= 100 && !hasShownLetter) showLetter();
        }
        function showFloatingText(text, color) {
            const txt = document.createElement('div'); txt.innerText = text; txt.classList.add('msg-float');
            txt.style.top = astronaut.style.top; txt.style.left = astronaut.style.left; txt.style.color = color;
            gameBox.appendChild(txt); setTimeout(() => txt.remove(), 2500);
        }
        function showMiniFloat(text, left, top, parent) {
            const floatTxt = document.createElement('div'); floatTxt.innerText = text; floatTxt.style.position = 'absolute';
            floatTxt.style.left = left; floatTxt.style.top = top; floatTxt.style.transform = 'translate(-50%, -50%)'; floatTxt.style.color = '#ffd700';
            floatTxt.style.fontWeight = 'bold'; floatTxt.style.fontSize = '1.5rem'; floatTxt.style.pointerEvents = 'none';
            floatTxt.style.animation = 'fadeUp 1s forwards'; parent.appendChild(floatTxt); setTimeout(() => floatTxt.remove(), 1000);
        }
        function showLetter() {
            playSound('notif'); isPaused = true; hasShownLetter = true;
            const finalMessage = `<div class="final-letter"><b>Untuk Ika,</b><br><br>Aku cuma mau bilang satu hal: Maaf. <br>Maaf buat semua sikapku yang dulu bikin kamu kecewa. Aku sadar, dulu aku banyak kurangnya, kurang peka, dan nggak menghargai apa yang ada.<br><br>Penyesalan ini mungkin telat, tapi ini jujur dari hati. Aku nggak minta apa-apa selain kamu tau kalau aku beneran nyesel pernah bikin kamu sedih.<br><br>Aku selalu mengharapkan kebahagiaan kamu.‚ú®</div>`;
            Swal.fire({ title: 'Pesan Masuk üì©', html: finalMessage, background: '#fff', color: '#333', width: 600, confirmButtonText: 'Lanjut Main üöÄ', confirmButtonColor: '#4facfe', allowOutsideClick: false, backdrop: `rgba(0,0,30,0.8)` }).then(() => { isPaused = false; });
        }
        function gameOver() {
            playSound('crash'); isGameRunning = false; clearInterval(gameLoop); clearInterval(spawnerLoop);
            Swal.fire({
                title: 'Misi Gagal üí•', text: 'Skor: ' + score, background: '#0b0d17', color: '#fff',
                showCancelButton: true, confirmButtonText: 'Coba Lagi', cancelButtonText: 'Menu Utama',
                confirmButtonColor: '#ff4b4b', cancelButtonColor: '#4facfe', allowOutsideClick: false
            }).then((result) => { if (result.isConfirmed) startGame(); else exitToMenu(); });
        }
    </script>
</body>
</html>